<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çŸ³æµ¸å´‡æ‹œæœäº‹è¡¨beta</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
      :root {
        --primary-color: #2c3e50; /* æ·±è—è‰² */
        --accent-color: #3498db;  /* äº®è—è‰² */
        --bg-color: #f4f7f9;
        --card-shadow: 0 4px 15px rgba(0,0,0,0.08);
        --highlight-bg: #fff3cd; /* é«˜äº®èƒŒæ™¯è‰² */
      }

      body { background-color: var(--bg-color); padding-bottom: 90px; font-family: -apple-system, "Microsoft JhengHei", sans-serif; }
      
      /* é ‚éƒ¨é¸å–® */
      .sticky-top-custom { 
        position: sticky; top: 0; z-index: 1020; 
        background: rgba(255, 255, 255, 0.95); 
        backdrop-filter: blur(10px); 
        padding: 15px 0; border-bottom: 2px solid var(--primary-color); 
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      }
      .filter-row { background: #fff; padding: 10px; border-radius: 10px; margin-bottom: 15px; border: 1px solid #eee; }

      /* é«˜äº®æ¨£å¼ */
      .highlight { background-color: var(--highlight-bg); padding: 2px 4px; border-radius: 3px; font-weight: bold; }

      /* éŸ¿æ‡‰å¼ä½ˆå±€ */
      .card-grid { display: flex; flex-wrap: wrap; margin: 0 -8px; }
      .card-wrapper { padding: 8px; width: 100%; }
      @media (min-width: 768px) { .card-wrapper { width: 50%; } }
      @media (min-width: 1200px) { .card-wrapper { width: 33.33%; } }

      /* å¡ç‰‡æ¨£å¼ - ä¿®æ”¹ç‚º Flex ä»¥è§£æ±ºå…§å®¹é‡ç–Šå•é¡Œ */
      .card { 
        height: 100%; border: none; border-radius: 12px; 
        background: #fff; box-shadow: var(--card-shadow);
        transition: transform 0.2s; 
        display: flex; flex-direction: column; /* é—œéµä¿®æ”¹ */
      }
      .card:hover { transform: translateY(-3px); }
      .card-body-custom {
        padding: 1rem;
        flex: 1; /* è®“å…§å®¹å€ä½”æ»¿å‰©é¤˜ç©ºé–“ */
      }

      /* æœ¬é€±æ¨™è¨˜ */
      .card.next-up { border: 2px solid var(--accent-color); position: relative; overflow: hidden; }
      .card.next-up::before {
        content: ""; position: absolute; top: 0; left: 0; right: 0; height: 6px; background: var(--accent-color);
      }
      .next-badge { background: var(--accent-color); color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; margin-left: 8px; vertical-align: middle; }
      .date-badge { background: var(--primary-color); color: white; padding: 5px 12px; border-radius: 6px; font-weight: bold; display: inline-block; }

      /* å…§å®¹æ’ç‰ˆ */
      .role-label { color: #95a5a6; font-size: 0.8rem; margin-bottom: 2px; text-transform: uppercase; letter-spacing: 0.5px; }
      .role-value { 
        font-size: 0.95rem; font-weight: 600; color: #2c3e50; 
        margin-bottom: 12px; border-left: 3px solid #dee2e6; padding-left: 10px; 
        word-break: break-word; /* é˜²æ­¢é•·æ–‡å­—ç ´ç‰ˆ */
      }
      .text-danger.role-value { border-left-color: #e74c3c; color: #e74c3c; }

      /* æŒ‰éˆ•å®¹å™¨ - ç¢ºä¿æŒ‰éˆ•åœ¨åº•éƒ¨ */
      .card-footer-custom {
        padding: 10px 1rem;
        background: transparent;
        margin-top: auto; /* å¼·åˆ¶æ¨åˆ°åº•éƒ¨ */
        text-align: right;
        border-top: 1px dashed #eee;
      }

      .btn-copy {
        font-size: 0.8rem;
        padding: 6px 16px;
        border-radius: 20px;
        background-color: var(--primary-color);
        color: white;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex; align-items: center; gap: 5px;
      }
      .btn-copy:hover { background-color: #1a252f; transform: scale(1.05); }
      .btn-copy:active { transform: scale(0.95); }

      /* Tab æ¨£å¼ */
      .nav-pills .nav-link { color: var(--primary-color); border: 1px solid #ddd; margin: 0 4px; background: #fff; font-size: 0.9rem; }
      .nav-pills .nav-link.active { background-color: var(--primary-color); border-color: var(--primary-color); box-shadow: 0 4px 6px rgba(44, 62, 80, 0.3); }

      .fab-btn { 
        position: fixed; bottom: 25px; right: 25px; z-index: 1030; 
        width: 56px; height: 56px; border-radius: 50%; 
        background-color: var(--accent-color); color: white; border: none; 
        box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4); display: none; 
        align-items: center; justify-content: center; font-size: 24px; 
        transition: transform 0.2s;
      }
      .fab-btn:active { transform: scale(0.9); }

      /* æœå°‹çµæœæç¤º */
      .no-results { text-align: center; color: #999; font-style: italic; padding: 20px; }
    </style>
</head>
<body>

    <div class="container">
      <div class="sticky-top-custom">
        <h5 class="text-center mb-3 fw-bold" style="color:var(--primary-color)">çŸ³æµ¸å´‡æ‹œæœäº‹è¡¨beta</h5>
        
        <div class="filter-row row gx-2">
          <div class="col-3"><select id="f-q" class="form-select form-select-sm" onchange="applyFilters()"><option value="">å­£åº¦</option></select></div>
          <div class="col-3"><select id="f-m" class="form-select form-select-sm" onchange="applyFilters()"><option value="">æœˆä»½</option>
            <script>for(let i=1;i<=12;i++) document.write(`<option value="${i}">${i}æœˆ</option>`);</script>
          </select></div>
          <div class="col-3"><select id="f-d" class="form-select form-select-sm" onchange="applyFilters()"><option value="">æ˜ŸæœŸ</option><option value="å…­">é€±å…­</option><option value="æ—¥">é€±æ—¥</option></select></div>
          <div class="col-3"><input type="text" id="f-name" class="form-control form-control-sm" placeholder="æœå°‹äººå" oninput="applyFilters()"></div>
        </div>

        <ul class="nav nav-pills nav-fill" id="myTab">
          <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#service" onclick="delayedJump()">âœï¸ å´‡æ‹œ</button></li>
          <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#band" onclick="delayedJump()">ğŸ¸ æ•¬æ‹œ</button></li>
          <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#sound" onclick="delayedJump()">ğŸšï¸ éŸ³æ§</button></li>
        </ul>
      </div>

      <div id="loading" class="text-center mt-5" style="color: #999;">
        <div class="spinner-border spinner-border-sm" role="status"></div>
        <p class="mt-2 small">æ­£åœ¨åŒæ­¥æœ€æ–°è³‡æ–™...</p>
      </div>

      <div class="tab-content mt-3" id="content-area" style="display:none; padding-bottom: 20px;">
        <div class="tab-pane fade show active" id="service"></div>
        <div class="tab-pane fade" id="band"></div>
        <div class="tab-pane fade" id="sound"></div>
      </div>

      <button class="fab-btn" id="fab" onclick="jumpToCurrent()" title="è·³è‡³æœ¬é€±">ğŸ“…</button>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      // â˜…â˜…â˜… è²¼ä¸Šä½ çš„ CSV ç¶²å€ â˜…â˜…â˜…
      const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSm1QyFJw29aaCzTeE71Arv4Taa6Kxfv82TD2IxKPinWsdGZnrQkOlCh8Zpv_tHvyYstXWQTSIJitG0/pub?gid=723640444&single=true&output=csv';

      let allRawData = []; 
      let nextServiceIds = { service: null, band: null, sound: null };

      window.onload = function() {
        if(!CSV_URL.startsWith("http")) return alert("è«‹è¨­å®š CSV ç¶²å€");
        Papa.parse(CSV_URL, {
          download: true,
          complete: function(results) {
            // ç°¡å–®æª¢æŸ¥ä¸€ä¸‹æ•¸æ“šæ˜¯å¦æœ‰æ•ˆï¼Œé¿å…ç©ºè¡Œå ±éŒ¯
            if(results.data && results.data.length > 2) {
              allRawData = results.data.slice(2).filter(r => r[1]); // æ¿¾æ‰æ²’æœ‰æ—¥æœŸçš„ç©ºè¡Œ
              setupQuarterFilter(allRawData);
              applyFilters();
            } else {
              alert("è®€å–è³‡æ–™å¤±æ•—ï¼Œè«‹æª¢æŸ¥ CSV æ ¼å¼");
            }
          },
          error: function() { alert("ç„¡æ³•é€£çµè‡³ Google Sheet"); }
        });
      };

      function setupQuarterFilter(rows) {
        const qSelect = document.getElementById('f-q');
        // ä½¿ç”¨ Set å»é‡ï¼Œç¢ºä¿å­£åº¦ä¸é‡è¤‡
        const quarters = [...new Set(rows.map(r => r[0]).filter(q => q))];
        quarters.forEach(q => {
          let opt = document.createElement('option');
          opt.value = q; opt.innerText = q;
          qSelect.appendChild(opt);
        });
        // é è¨­é¸ä¸­æœ€å¾Œä¸€å€‹å­£åº¦ (é€šå¸¸æ˜¯æœ€æ–°çš„)
        // if(quarters.length > 0) qSelect.value = quarters[quarters.length-1];
      }

      function applyFilters() {
        const qVal = document.getElementById('f-q').value;
        const mVal = document.getElementById('f-m').value;
        const dVal = document.getElementById('f-d').value;
        const nameVal = document.getElementById('f-name').value.toLowerCase().trim();
        const activeTab = document.querySelector('.tab-pane.active').id;
        
        const filtered = allRawData.filter(row => {
          if (!row[1]) return false;
          // æ¨¡ç³Šæ¯”å°å¢å¼·å®¹éŒ¯æ€§
          const matchQ = !qVal || row[0] === qVal;
          const matchM = !mVal || parseInt(row[1].split('/')[0]) == parseInt(mVal);
          const matchD = !dVal || row[2].includes(dVal);
          // æ–°å¢äººåæœå°‹ï¼šæª¢æŸ¥ç•¶å‰æ´»èºTabçš„ç›¸é—œæ¬„ä½
          const matchName = !nameVal || searchNamesInRow(row, nameVal, activeTab);
          return matchQ && matchM && matchD && matchName;
        });
        renderContent(filtered, nameVal, activeTab);
      }

      function searchNamesInRow(row, query, activeTab) {
        let nameFields = [];
        if (activeTab === 'service') {
          // å´‡æ‹œç›¸é—œæ¬„ä½ï¼šæœƒå‰ç¦±å‘Š,ä¸»å¸­,è¬›å“¡,è–é¤,æ‹›å¾…
          nameFields = [3, 5, 6, 22, 23];
        } else if (activeTab === 'band') {
          // æ•¬æ‹œåœ˜ç›¸é—œæ¬„ä½ï¼šä¸»é ˜,Vocal,é‹¼ç´,KB,å‰ä»–,Bass,é¼“
          nameFields = [8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18];
        } else if (activeTab === 'sound') {
          // éŸ³æ§ç›¸é—œæ¬„ä½ï¼šéŸ³æ§,PPT
          nameFields = [20, 21];
        }
        return nameFields.some(index => {
          const value = (row[index] || '').toString().toLowerCase();
          return value.includes(query);
        });
      }

      function renderContent(data, highlightQuery = '', activeTab) {
        let htmls = { service: '<div class="card-grid">', band: '<div class="card-grid">', sound: '<div class="card-grid">' };
        const today = new Date(); today.setHours(0,0,0,0);
        let foundNext = false;

        // é‡æ–°è¨ˆç®— nextServiceIdsï¼Œæ ¹æ“šéæ¿¾å¾Œçš„æ•¸æ“š
        nextServiceIds = { service: null, band: null, sound: null };

        data.forEach((row, index) => {
          // --- æ—¥æœŸè™•ç† ---
          const dateParts = row[1].split('/');
          let rowDate = new Date(today.getFullYear(), dateParts[0]-1, dateParts[1]);
          if (today.getMonth() == 11 && parseInt(dateParts[0]) == 1) rowDate.setFullYear(today.getFullYear() + 1);
          else if (today.getMonth() == 0 && parseInt(dateParts[0]) == 12) rowDate.setFullYear(today.getFullYear() - 1);
          
          // --- æœ¬é€±åˆ¤æ–· ---
          let isNext = false;
          if (!foundNext && rowDate >= today) { isNext = true; foundNext = true; }
          const uId = 'idx-' + index;
          if(isNext) { nextServiceIds.service='s-'+uId; nextServiceIds.band='b-'+uId; nextServiceIds.sound='v-'+uId; }

          // --- å¡ç‰‡æ¨™é ­ ---
          const header = `<div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
            <div><span class="date-badge">${row[1]}</span> <span class="fw-bold ms-1" style="font-size:0.9rem">${row[2]}</span>${isNext ? '<span class="next-badge">æœ¬é€±</span>' : ''}</div>
            <small class="text-muted" style="font-size:0.75rem">${row[0]}</small>
          </div>`;

          // --- é€™è£¡ä¿®æ­£äº†ï¼šåƒæ•¸å‚³éæ–¹å¼ ---
          const cardStart = `<div class="card-wrapper"><div class="card ${isNext?'next-up':''}" id="PREFIX-${uId}"><div class="card-body-custom">${header}<div class="row g-2">`;
          
          // â˜…â˜…â˜… é—œéµä¿®æ­£ï¼šä½¿ç”¨ encodeURIComponent é¿å…å¼•è™Ÿç ´å£ HTML â˜…â˜…â˜…
          const cardEnd = (fnName, ...args) => {
              const safeArgs = args.map(a => 
                  `decodeURIComponent('${encodeURIComponent((a || '').toString())}')`
              ).join(","); 
              return `</div></div><div class="card-footer-custom"><button class="btn-copy" onclick="${fnName}(${safeArgs})">âœ¨ è¤‡è£½è³‡è¨Š</button></div></div></div>`;
          };

          // 1. å´‡æ‹œ
          htmls.service += cardStart.replace('PREFIX', 's') + 
            `${c('è¬›å“¡', row[6], false, '', highlightQuery)}${c('è¬›é¡Œ', row[7], true, 'text-danger', highlightQuery)}${c('ä¸»å¸­', row[5], false, '', highlightQuery)}${c('æœƒå‰ç¦±å‘Š', row[3], false, '', highlightQuery)}${c('è–é¤', row[22], false, '', highlightQuery)}${c('æ‹›å¾…', row[23], false, '', highlightQuery)}${c('å‚™è¨»', row[24], true, '', highlightQuery)}` + 
            cardEnd('copyService', row[1], row[2], row[6], row[7], row[5]);

          // 2. æ•¬æ‹œåœ˜
          if(row[8] || row[13]) {
            htmls.band += cardStart.replace('PREFIX', 'b') + 
              `${c('ä¸»é ˜', row[8], false, 'text-primary', highlightQuery)}${c('Vocal', [row[9],row[10],row[11],row[12]].filter(x=>x).join(', '), true, '', highlightQuery)}
               ${c('é‹¼ç´', row[13], false, '', highlightQuery)}${c('KB', row[14], false, '', highlightQuery)}${c('å‰ä»–', (row[15]||'')+' '+(row[16]||''), false, '', highlightQuery)}${c('Bass', row[17], false, '', highlightQuery)}${c('é¼“', row[18], false, '', highlightQuery)}` + 
               cardEnd('copyBand', row[1], row[8], row[13], row[18]);
          }

          // 3. éŸ³æ§
          if(row[20] || row[21]) {
            htmls.sound += cardStart.replace('PREFIX', 'v') + 
              `${c('éŸ³æ§', row[20], false, '', highlightQuery)}${c('PPT', row[21], false, '', highlightQuery)}` + 
              cardEnd('copySound', row[1], row[20], row[21]);
          }
        });

        // --- æ ¹æ“šæ˜¯å¦æœ‰æœå°‹è©æ±ºå®šæ¸²æŸ“æ–¹å¼ ---
        if (highlightQuery) {
          // æœ‰æœå°‹è©æ™‚ï¼Œåªæ¸²æŸ“æ´»èºTabï¼Œå…¶ä»–Tabé¡¯ç¤ºç„¡çµæœè¨Šæ¯
          for (let key in htmls) {
            if (key === activeTab) {
              document.getElementById(key).innerHTML = htmls[key] + '</div>';
            } else {
              document.getElementById(key).innerHTML = '<div class="no-results">è«‹åˆ‡æ›åˆ°æ­¤Tabé€²è¡Œæœå°‹</div>';
            }
          }
        } else {
          // ç„¡æœå°‹è©æ™‚ï¼Œæ­£å¸¸æ¸²æŸ“æ‰€æœ‰Tab
          for(let key in htmls) document.getElementById(key).innerHTML = htmls[key] + '</div>';
        }
        
        document.getElementById('loading').style.display = 'none';
        document.getElementById('content-area').style.display = 'block';
        if(foundNext) document.getElementById('fab').style.display = 'flex';
        if(!document.getElementById('f-q').value && !document.getElementById('f-m').value) setTimeout(jumpToCurrent, 500);
      }

      // ä¿®æ”¹cå‡½æ•¸ï¼ŒåŠ å…¥é«˜äº®åŠŸèƒ½ï¼Œä½†åƒ…é©ç”¨æ–¼étext-dangerçš„vcï¼ˆå› ç‚ºå‚™è¨»æœ¬å°±æ˜¯dangerï¼Œä¸¦ä¸”highlightçœ‹èµ·ä¾†æœ‰è¡çªï¼Œæ‰€ä»¥å–æ¶ˆå‚™è¨»çš„é«˜äº®ï¼‰
      function c(l, v, f = false, vc = '', highlightQuery = '') {
        if (!v || v.toString().trim() === '') return ''; 
        let valueHtml = vc === 'text-danger' && l === 'å‚™è¨»' ? v : (highlightQuery && vc !== 'text-danger' ? highlightText(v, highlightQuery) : v);
        return `<div class="${f ? 'col-12' : 'col-6'}"><p class="role-label">${l}</p><p class="role-value ${vc}">${valueHtml}</p></div>`;
      }

      // æ–°å¢é«˜äº®å‡½æ•¸ï¼šå°‡åŒ¹é…çš„æ–‡å­—åŒ…åœé«˜äº®æ¨™ç±¤
      function highlightText(text, query) {
        const lowerText = text.toLowerCase();
        const lowerQuery = query.toLowerCase();
        let result = '';
        let lastIndex = 0;
        while (true) {
          const index = lowerText.indexOf(lowerQuery, lastIndex);
          if (index === -1) break;
          result += text.substring(lastIndex, index) + `<span class="highlight">${text.substr(index, query.length)}</span>`;
          lastIndex = index + query.length;
        }
        result += text.substring(lastIndex);
        return result;
      }

      // --- å‰ªè²¼ç°¿é‚è¼¯ (ç›¸å®¹æ€§èˆ‡ä¿®å¾©) ---
      
      async function execCopy(text) {
        // å„ªå…ˆå˜—è©¦ç¾ä»£ API (æ‰‹æ©Ÿæ”¯æ´åº¦è¼ƒå¥½)
        if (navigator.clipboard && navigator.clipboard.writeText) {
            try {
                await navigator.clipboard.writeText(text);
                alert("âœ… å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼");
                return;
            } catch (err) {
                console.error('Clipboard API failed, falling back...', err);
            }
        }

        // å‚™ç”¨æ–¹æ¡ˆï¼šå‚³çµ± execCommand (é‡å° HTTP ç’°å¢ƒæˆ–èˆŠç€è¦½å™¨)
        const textArea = document.createElement("textarea");
        textArea.value = text;
        
        // é¿å…æ‰‹æ©Ÿä¸Šè·³å‡ºéµç›¤
        textArea.style.position = "fixed";
        textArea.style.left = "-9999px";
        textArea.setAttribute('readonly', '');
        
        document.body.appendChild(textArea);
        textArea.select();
        textArea.setSelectionRange(0, 99999); // iOS fix

        try {
          const success = document.execCommand('copy');
          if(success) alert("âœ… å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ (Fallback)ï¼");
          else throw new Error("Copy failed");
        } catch (err) {
          prompt("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ä»¥ä¸‹å…§å®¹ï¼š", text);
        } finally {
          document.body.removeChild(textArea);
        }
      }

      function copyService(date, day, speaker, topic, chair) {
        execCopy(`ğŸŒŸ ã€å´‡æ‹œæœäº‹æé†’ã€‘\næ—¥æœŸï¼š${date} (${day})\nä¸»å¸­ï¼š${chair}\nè¬›å“¡ï¼š${speaker}\nè¬›é¡Œï¼š${topic}\n\nè«‹é å‚™å¿ƒæœäº‹ï¼`);
      }
      function copyBand(date, leader, piano, drums) {
        execCopy(`ğŸ¸ ã€æ•¬æ‹œåœ˜æœäº‹ã€‘\næ—¥æœŸï¼š${date}\nä¸»é ˜ï¼š${leader}\né‹¼ç´ï¼š${piano}\né¼“æ‰‹ï¼š${drums}\n\nè«‹é å‚™å¿ƒæœäº‹ï¼`);
      }
      function copySound(date, sound, ppt) {
        execCopy(`ğŸšï¸ ã€éŸ³æ§æœäº‹ã€‘\næ—¥æœŸï¼š${date}\néŸ³æ§ï¼š${sound}\nPPTï¼š${ppt}\n\nè«‹é å‚™å¿ƒæœäº‹ï¼`);
      }

      // --- æ»¾å‹•å®šä½ä¿®å¾© ---
      function jumpToCurrent() {
        const activeTab = document.querySelector('.tab-pane.active').id;
        const tid = nextServiceIds[activeTab];
        if (tid) {
          const el = document.getElementById(tid);
          if(el) {
            // ä½¿ç”¨ scrollIntoView é…åˆ block: center ç¢ºä¿ä¸æœƒè¢« header æ“‹ä½
            el.scrollIntoView({ behavior: "smooth", block: "center" });
            
            // è¦–è¦ºå›é¥‹ï¼šé–ƒçˆä¸€ä¸‹
            el.style.transition = "background-color 0.5s";
            el.style.backgroundColor = "#eaf2f8";
            setTimeout(() => { el.style.backgroundColor = "#fff"; }, 1000);
          }
        } else {
            // å¦‚æœè©² Tab æ²’æœ‰æœ¬é€±æ•¸æ“šï¼ˆä¾‹å¦‚ç¯©é¸æ‰äº†ï¼‰
            // alert("æœ¬é é¢æ²’æœ‰æœ¬é€±è³‡æ–™");
        }
      }
      function delayedJump() { setTimeout(jumpToCurrent, 300); }
    </script>
</body>
</html>
